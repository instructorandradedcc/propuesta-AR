<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Realidad Aumentada - Propuesta</title>
  
  <!-- Favicon -->
  <link rel="icon" href="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/favicon3dAR.ico">

  <!-- A-Frame y MindAR -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  
  <!-- Tailwind CSS para el diseño -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Estilos personalizados para mejorar la interfaz */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f2f5;
    }
    .ar-container {
      position: relative;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }
    .controls-panel {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      max-width: 320px;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      padding: 20px;
      overflow-y: auto;
      z-index: 10;
      transition: transform 0.3s ease-in-out;
    }
    .scene-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    .control-button {
      transition: all 0.2s ease;
    }
    .control-button.active {
      background-color: #0d6efd;
      color: white;
      font-weight: bold;
    }
    #marker-preview {
      border: 2px dashed #ccc;
    }
    /* Responsividad para móviles */
    @media (max-width: 768px) {
      .controls-panel {
        max-width: 100%;
        height: auto;
        max-height: 50vh;
        bottom: 0;
        top: auto;
        transform: translateY(calc(100% - 60px)); /* Inicialmente colapsado */
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
      }
      .controls-panel.open {
        transform: translateY(0);
      }
      .toggle-button {
        display: block;
      }
    }
    @media (min-width: 769px) {
        .scene-container {
            left: 320px;
            width: calc(100% - 320px);
        }
    }
  </style>
</head>
<body>
  <div class="ar-container">
    <!-- Panel de Controles -->
    <div id="controls" class="controls-panel">
      <div class="flex items-center justify-between mb-6">
        <img src="https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/logofundacion.jpg" alt="Logo Fundación" class="h-12 w-auto">
        <button id="panel-toggle" class="md:hidden p-2 rounded-md bg-gray-200">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>
        </button>
      </div>

      <h2 class="text-xl font-bold text-gray-800 mb-2">Modelos 3D</h2>
      <p class="text-sm text-gray-500 mb-4">Selecciona un modelo y apunta tu cámara al marcador correspondiente.</p>
      
      <div id="buttons-container" class="space-y-2 mb-6">
        <!-- Los botones de los modelos se insertarán aquí -->
      </div>
      
      <div class="mt-auto">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Marcador Actual</h3>
          <div class="bg-white p-2 rounded-lg shadow-inner">
             <img id="marker-preview" src="" alt="Vista previa del marcador" class="w-full rounded-md object-contain h-48">
          </div>
      </div>
    </div>

    <!-- Contenedor de la Escena AR -->
    <div class="scene-container">
      <a-scene id="ar-scene" mindar-image="uiScanning: #scanning-ui; autoStart: false;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        
        <!-- UI de Escaneo Personalizada -->
        <div id="scanning-ui" class="absolute inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center text-white text-2xl font-semibold z-20">
            <div class="text-center">
                <p>Buscando marcador...</p>
                <div class="mt-4 animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
            </div>
        </div>

        <a-assets>
            <!-- El modelo inicial se cargará aquí -->
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        
        <a-entity id="target-entity" mindar-image-target="targetIndex: 0">
          <a-gltf-model id="model-3d" rotation="0 0 0" position="0 0 0" scale="0.1 0.1 0.1" src="" animation-mixer>
          </a-gltf-model>
        </a-entity>
      </a-scene>
    </div>
  </div>

  <!-- Botón de Inicio -->
  <div id="start-overlay" class="absolute inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-30">
      <button id="start-button" class="px-8 py-4 bg-blue-600 text-white font-bold text-lg rounded-full shadow-lg hover:bg-blue-700 transition-transform transform hover:scale-105">
          Iniciar Experiencia AR
      </button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const baseUrl = "https://raw.githubusercontent.com/instructorandradedcc/propuesta-AR/main/asetss/";
      const models = [
        { name: "Cabeza", baseFile: "cabeza1" },
        { name: "Corazón", baseFile: "corazon" },
        { name: "Dedo y Mano", baseFile: "dedo-mano" },
        { name: "Dedo", baseFile: "dedo" },
        { name: "Columna Vertebral", baseFile: "hueso-columna" },
        { name: "Huesos de la Mano", baseFile: "huesosmano" },
        { name: "Prótesis de Mano", baseFile: "mano-iz-protesis" },
        { name: "Prótesis de Brazo", baseFile: "protesis-mano-brazo" },
      ];

      const sceneEl = document.querySelector('#ar-scene');
      const model3D = document.querySelector('#model-3d');
      const markerPreview = document.querySelector('#marker-preview');
      const buttonsContainer = document.querySelector('#buttons-container');
      const startButton = document.querySelector('#start-button');
      const startOverlay = document.querySelector('#start-overlay');
      const controlsPanel = document.querySelector('#controls');
      const panelToggle = document.querySelector('#panel-toggle');

      let arSystem; // Se inicializará después de que la escena esté cargada

      sceneEl.addEventListener('loaded', () => {
        arSystem = sceneEl.systems["mindar-image-system"];
      });
      
      // Función para cambiar de modelo
      const switchModel = (modelData, buttonEl) => {
        if (!arSystem) {
            console.error("AR System not ready.");
            return;
        }

        arSystem.stop();

        const mindUrl = `${baseUrl}markers/${modelData.baseFile}.mind`;
        const glbUrl = `${baseUrl}modelss/${modelData.baseFile}.glb`;
        const imageUrl = `${baseUrl}imagenes/${modelData.baseFile}.png`;
        
        sceneEl.setAttribute('mindar-image', { imageTargetSrc: mindUrl });
        model3D.setAttribute('gltf-model', glbUrl);
        markerPreview.src = imageUrl;

        // Actualizar el botón activo
        document.querySelectorAll('.control-button').forEach(btn => btn.classList.remove('active'));
        if (buttonEl) {
            buttonEl.classList.add('active');
        }

        arSystem.start();
      };

      // Crear botones dinámicamente
      models.forEach((model, index) => {
        const button = document.createElement('button');
        button.innerText = model.name;
        button.className = 'control-button w-full text-left px-4 py-3 rounded-lg bg-gray-200 hover:bg-gray-300';
        if (index === 0) {
          button.classList.add('active'); // Activar el primer botón por defecto
        }
        button.addEventListener('click', () => switchModel(model, button));
        buttonsContainer.appendChild(button);
      });

      // Lógica del botón de inicio
      startButton.addEventListener('click', () => {
        startOverlay.style.display = 'none';
        // Iniciar con el primer modelo de la lista
        switchModel(models[0], buttonsContainer.children[0]);
      });

      // Lógica para mostrar/ocultar panel en móviles
      panelToggle.addEventListener('click', () => {
          controlsPanel.classList.toggle('open');
          const svg = panelToggle.querySelector('svg');
          // Cambiar la dirección de la flecha
          if (controlsPanel.classList.contains('open')) {
              svg.style.transform = 'rotate(180deg)';
          } else {
              svg.style.transform = 'rotate(0deg)';
          }
      });
    });
  </script>
</body>
</html>

